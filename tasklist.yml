---
- id: 001
  status: completed
  prompt: |
    Implement canonical hostname resolution and enforce it across replication.
    - Add `dirsrv_target_type` default (`container`), and compute `dirsrv_advertised_hostname_final` following AGENTS.md priority:
      1) `dirsrv_advertised_hostname` if defined;
      2) if `dirsrv_target_type == 'container'` then `inventory_hostname` (Compose service name);
      3) else `ansible_fqdn | default(inventory_hostname)`.
    - In `roles/dirsrv_repl/tasks/agreements.yml`, use `dirsrv_advertised_hostname_final` for the consumer host when creating agreements instead of raw `target.host`.
    - Add an assertion in preflight to forbid IP-literals and mixing service names with FQDNs in `dirsrv_repl_nodes`.
    Files: `roles/dirsrv_repl/defaults/main.yml`, `roles/dirsrv_repl/tasks/main.yml` or `roles/dirsrv_common/tasks/preflight.yml`, `roles/dirsrv_repl/tasks/agreements.yml`.
    Acceptance: Agreements list (`dsconf repl-agmt list`) shows only canonical names; asserts fail on IP addresses.

- id: 002
  status: completed
  prompt: |
    Enforce no-restart contract for INT.
    - Add `env_type` var (`dev`|`int`) and default `dirsrv_no_restart: "{{ env_type == 'int' }}"` in a central defaults file.
    - Guard all restart/stop/start operations with `when: not dirsrv_no_restart` and emit a clear warning `debug: warn=true` when skipped.
    - Affected tasks: TLS restart (`roles/dirsrv_tls/tasks/main.yml`), mapping-tree referral restart (`roles/dirsrv_repl/tasks/enable.yml`), suffix-disabled recovery restart (`roles/dirsrv_repl/tasks/error_recovery.yml`), and migrate target systemd restart (`roles/dirsrv_migrate/tasks/target.yml`).
    Acceptance: Running with `-e env_type=int` results in zero restarts; tasks show skip warnings.

- id: 003
  status: completed
  prompt: |
    Serialize initialization to avoid replica locks.
    - Re-introduce `throttle: 1` on the `directories.ds.ds_repl_init` task in `roles/dirsrv_repl/tasks/agreements.yml`.
    - Add a short comment explaining lock contention (UpdateInProgress/RUV) rationale per DESIGN.md.
    Acceptance: Parallelism removed for init; repeated runs show no `UpdateInProgress` errors.

- id: 004
  status: completed
  prompt: |
    Standardize variable prefixes; deprecate `rhds_*`.
    - Rename `rhds_disable_referrals` -> `dirsrv_repl_disable_referrals` across defaults, tasks, tests, and docs; remove any compatibility shims.
    - Rename all `rhds_repl_wait_*` to `dirsrv_repl_wait_*`; update `roles/dirsrv_repl/tasks/wait_green.yml` references and test var files under `test/`.
    - Update README/examples accordingly.
    Acceptance: `rg -n "\brhds_"` returns no matches (excluding this tasklist).

- id: 005
  status: completed
  prompt: |
    Add INT-specific Compose and Make targets with pinned image digests and ephemeral storage.
    - Create `compose/podman-compose.389ds.int.yml` that: uses `quay.io/389ds/dirsrv@sha256:<digest>`, replaces bind mounts with anonymous volumes/tmpfs, and keeps `dsnet`.
    - Add Make targets: `up_int`, `test_int` mirroring DEV flow but using INT compose and exporting artifacts before teardown.
    - Document digest override via env var (e.g., `DS_IMAGE_DIGEST`).
    Acceptance: `make up_int` starts containers with digest-pinned images and no bind mounts; `make test_int` runs end-to-end and bundles artifacts before down.

- id: 006
  status: completed
  prompt: |
    Validate node hostnames; forbid IP literals and mixed addressing.
    - In `roles/dirsrv_common/tasks/preflight.yml`, add asserts that:
      - `dirsrv_repl_nodes[host].host` is not an IPv4/IPv6 literal;
      - For `dirsrv_target_type == 'container'`, host is a Compose service name (no dots) or `*.dsnet.test`;
      - For VMs, require FQDNs (no short names) and not under `dsnet.test`.
    - Fail fast with actionable messages.
    Acceptance: Misconfigured inventories fail with clear preflight errors.

- id: 007
  status: completed
  prompt: |
    Scope heavy container network preflight to containers only and make it toggleable.
    - Add `dirsrv_network_validate: true` default; wrap Podman network inspection and `/etc/hosts` conflict checks with `when: dirsrv_network_validate and dirsrv_target_type == 'container'`.
    - Reduce inline Python by extracting small checks to Jinja/Ansible where practical; keep `argv` and `changed_when: false` everywhere.
    Acceptance: On VMs, preflight skips container-only checks; behavior controlled by `dirsrv_network_validate`.

- id: 008
  status: completed
  prompt: |
    Remove dead Python helper `roles/dirsrv_repl/library/retry_utils.py` and any unused references.
    - Delete the file and ensure no tasks/imports reference it.
    Acceptance: File removed; repo greps show no usage.

- id: 009
  status: completed
  prompt: |
    Implement and use `dirsrv_advertised_hostname_final` in replication modules’ inputs.
    - In `roles/dirsrv_repl/tasks/agreements.yml`, compute `target_host_effective` per agreement using the canonical resolution and pass that to `directories.ds.ds_repl_agreement.consumer_host`.
    - Ensure monitoring and wait tasks display canonical names in summaries.
    Acceptance: Module snapshots and debug output show only canonical names.

- id: 010
  status: completed
  prompt: |
    Tighten secret handling and logging hygiene.
    - Ensure all tasks that pass `-w {{ dirsrv_password }}` or `--bind-passwd` have `no_log: true` (or redaction logic) consistently.
    - Audit `roles/dirsrv_repl/tasks/*` and `roles/dirsrv_migrate/tasks/*` for any misses; add explicit `changed_when/failed_when` where missing.
    Acceptance: No CLI secrets appear in Ansible JSON logs when `dirsrv_debug=false`.

- id: 011
  status: completed
  prompt: |
    Collections workflow targets parity with policy.
    - Add `make collection_install_dev` (installs to `.ansible/collections`) and `make collection_install_user` (installs to `~/.ansible/collections`) as thin wrappers; keep existing `collection_build` intact.
    - Update README snippet if present.
    Acceptance: Both new targets run successfully and install the latest built tarball.

- id: 012
  status: completed
  prompt: |
    Strengthen INT acceptance gates and timeouts.
    - Wire `dirsrv_repl_wait_*` (post-rename) defaults to align with DESIGN.md SLAs; fail the play if steady-state not reached within configured time.
    - Add an early assert that `ansible_date_time.tz` and NTP service (chronyd/ntpd/timesyncd) are sane with `warn` and explicit failure option for INT.
    Acceptance: INT runs halt on SLA breaches; logs include clear failure reasons.

- id: 013
  status: completed
  prompt: |
    Ensure agreements initialization is serialized per suffix.
    - In addition to `throttle: 1`, group init per-suffix and run supplier→consumer `init: true` items one at a time with a small inter-init delay (`pause: seconds=2`) to avoid RUV contention.
    Acceptance: No contention warnings when initializing multiple consumers.

- id: 014
  status: pending
  prompt: |
    Provide a compatibility shim for existing inventories and tests.
    - After introducing canonical hostnames and var renames, add temporary compatibility in defaults to map old var names to new, with a `debug: warn=true` deprecation notice.
    - Add a `docs/VARIABLES_AND_COMPATIBILITY.md` update snippet to reflect the change window.
    Acceptance: Existing `test/*` continues to pass without immediate var churn; warnings guide migration.

- id: 015
  status: completed
  prompt: |
    Add IP-literal guardrails to agreements data.
    - Add an `assert` in `roles/dirsrv_repl/tasks/agreements.yml` verifying `dirsrv_repl_nodes[*].host` does not match IPv4/IPv6 literal regex and is a resolvable name.
    - Include actionable `fail_msg` per AGENTS.md.
    Acceptance: Bad inputs fail fast with clear messages.
